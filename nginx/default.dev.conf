# nginx/default.dev.conf (Development - HTTP Only)

proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1G inactive=60m use_temp_path=off;

# --- Gzip Compression ---
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 5;
gzip_min_length 256;
gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;

upstream backend_server {
    server backend:8000;
}

upstream frontend_server {
    server frontend:3000;
}

server {
    listen 80;
    server_name localhost;

    # Увеличиваем лимит для загрузки фото/видео
    client_max_body_size 100M;

    # --- Security Headers (Dev HTTP Safe) ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # --- Micro-Caching for API ---
    location ~ ^/api/(products|categories|banners|articles|faq|deal-of-the-day|settings)/ {
        proxy_cache api_cache;
        proxy_cache_valid 200 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        
        add_header X-Cache-Status $upstream_cache_status;
        
        # --- Security Headers (Duplicate due to Nginx inheritance rules) ---
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # Bypass cache if user is logged in (sessionid cookie)
        proxy_cache_bypass $cookie_sessionid;
        proxy_no_cache $cookie_sessionid;

        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API, Админка и CKEditor -> Django Backend (No Cache)
    location ~ ^/(api|admin|ckeditor5)/ {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Статика и Медиа Django
    location /django-static/ {
        alias /app/staticfiles/;
        access_log off;
    }

    location /media/ {
        alias /app/media/;
        access_log off;
    }

    # Все остальное -> Next.js Frontend
    location / {
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
